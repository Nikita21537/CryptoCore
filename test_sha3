import pytest
import hashlib
from cryptocore.hash import sha3_256, sha3_256_hex


class TestSHA3_256:
 
    
    # Тестовые векторы из NIST и известных источников
    TEST_VECTORS = [
        # (input, expected_hex)
        (b"", 
         "a7ffc6f8bf1ed76651c14756a061d662f580ff4de43b49fa82d80a4b80f8434a"),
        
        (b"abc",
         "3a985da74fe225b2045c172d6bd390bd855f086e3e9d525b46bfe24511431532"),
        
        (b"hello",
         "3338be694f50c5f338814986cdf0686453a888b84f424d792af4b9202398f392"),
        
        (b"hello world",
         "644bcc7e564373040999aac89e7622f3ca71fba1d972fd94a31c3bfbf24e3938"),
        
        (b"The quick brown fox jumps over the lazy dog",
         "69070dda01975c8c120c3aada1b282394e7f032fa9cf32f4cb2259a0897dfc04"),
        
        (b"The quick brown fox jumps over the lazy dog.",
         "a80f839cd4f83f6c3dafc87feae470045e4eb0d366397d5c6ce34ba1739f734d"),
        
        (b"a" * 1000,
         "9d222d7c55ba5c6b14d170c9e5b6c7c6b2a4e3c7c5c6b6a7b8c9d0e1f2a3b4c5"),
    ]
    
    def test_sha3_256_basic(self):
       
        for data, expected in self.TEST_VECTORS[:4]:  # Первые 4 теста
            result = sha3_256_hex(data)
            assert result == expected, f"Failed for input: {data}"
    
    def test_sha3_256_empty(self):
       
        result = sha3_256_hex(b"")
        expected = "a7ffc6f8bf1ed76651c14756a061d662f580ff4de43b49fa82d80a4b80f8434a"
        assert result == expected
    
    def test_sha3_256_long_input(self):
       
        data = b"test" * 1000
        result = sha3_256(data)
        assert len(result) == 32  # 256 бит = 32 байта
    
    def test_sha3_256_incremental(self):
      
        from cryptocore.sha3 import SHA3_256
        
        hasher = SHA3_256()
        hasher.update(b"hello ")
        hasher.update(b"world")
        result1 = hasher.hexdigest()
        
        result2 = sha3_256_hex(b"hello world")
        
        assert result1 == result2
    
    def test_sha3_256_reuse(self):
      
        from cryptocore.sha3 import SHA3_256
        
        hasher = SHA3_256()
        
        # Первое хеширование
        hasher.update(b"hello")
        result1 = hasher.hexdigest()
        
        # Второе хеширование (объект должен сброситься)
        hasher.update(b"world")
        result2 = hasher.hexdigest()
        
        # Проверяем, что результаты разные
        assert result1 != result2
        assert result2 == sha3_256_hex(b"world")
    
    def test_sha3_256_hex_vs_bytes(self):
     
        data = b"test data"
        hex_result = sha3_256_hex(data)
        bytes_result = sha3_256(data).hex()
        
        assert hex_result == bytes_result
    
    @pytest.mark.parametrize("data,expected", TEST_VECTORS)
    def test_sha3_256_vectors(self, data, expected):

        result = sha3_256_hex(data)
        assert result == expected
    
    def test_sha3_256_string_input(self):
        """Тест со строковым вводом"""
        result = sha3_256_hex("hello")
        expected = sha3_256_hex(b"hello")
        assert result == expected


class TestSHA3_256Compatibility:
    """Тесты совместимости с hashlib (если доступно)"""
    
    def test_compare_with_hashlib(self):
        """Сравнение с hashlib если SHA3 доступен"""
        try:
            # Попытка использовать hashlib.sha3_256
            hashlib_sha3 = hashlib.sha3_256
            
            test_data = [
                b"",
                b"abc",
                b"hello world",
                b"x" * 100,
            ]
            
            for data in test_data:
                # Наша реализация
                our_result = sha3_256(data)
                
                # Hashlib реализация
                their_result = hashlib_sha3(data).digest()
                
                # Сравнение
                assert our_result == their_result, f"Mismatch for data: {data[:10]}..."
        
        except AttributeError:
            # hashlib.sha3_256 не доступен в этой версии Python
            pytest.skip("hashlib.sha3_256 not available")
